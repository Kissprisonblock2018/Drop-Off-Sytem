<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Lato', sans-serif;
        font-weight: 400;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
        border: 2px solid #000000;
      }

      h1 {
        font-weight: 900;
        color: #000000;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.2em;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h3 {
        font-weight: 700;
        color: #58b73a;
        margin-bottom: 25px;
        font-size: 1.5em;
        border-bottom: 2px solid #000000;
        padding-bottom: 10px;
      }

      .main-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .main-buttons button {
        flex: 1;
        min-width: 250px;
        max-width: 300px;
      }

      button {
        font-family: 'Lato', sans-serif;
        font-weight: 700;
        padding: 15px 30px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }

      button:hover:not(:disabled)::before {
        left: 100%;
      }

      .btn-primary {
        background: white;
        color: #58b73a;
        border: 2px solid #000000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-primary:hover:not(:disabled) {
        background: #58b73a;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(88, 183, 58, 0.4);
      }

      .btn-secondary {
        background: white;
        color: #58b73a;
        border: 2px solid #000000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary:hover:not(:disabled) {
        background: #58b73a;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(88, 183, 58, 0.4);
      }

      .btn-add {
        background: white;
        color: #58b73a;
        border: 2px solid #000000;
        padding: 10px 20px;
        font-size: 14px;
        margin-right: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      }

      .btn-add:hover:not(:disabled) {
        background: #58b73a;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(88, 183, 58, 0.3);
      }

      .btn-save {
        background: white;
        color: #58b73a;
        border: 2px solid #000000;
        padding: 12px 25px;
        font-size: 16px;
        font-weight: 900;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-save:hover:not(:disabled) {
        background: #58b73a;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(88, 183, 58, 0.4);
      }

      .btn-remove {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 8px 15px;
        font-size: 12px;
        margin-top: 10px;
        box-shadow: 0 3px 10px rgba(220, 53, 69, 0.2);
        border: 2px solid #000000;
      }

      .btn-remove:hover {
        background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
      }

      .entry {
        border: 2px solid #000000;
        padding: 25px;
        margin: 20px 0;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .entry:hover {
        border-color: #000000;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .entry:first-child {
        background: linear-gradient(135deg, #e6f3ff 0%, #f0f8ff 100%);
        border-color: #000000;
      }

      label {
        font-weight: 700;
        color: #58b73a;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      input[type="text"], select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #000000;
        border-radius: 8px;
        font-family: 'Lato', sans-serif;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fafafa;
      }

      input[type="text"]:focus, select:focus {
        outline: none;
        border-color: #000000;
        background: white;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      }

      select {
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .action-buttons button {
        flex: 1;
        min-width: 180px;
        max-width: 220px;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #58b73a;
        font-weight: 700;
      }

      .order-selection {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .order-selection > div {
        flex: 1;
        min-width: 200px;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
      }

      @media (max-width: 600px) {
        .container {
          margin: 10px;
          padding: 20px;
        }
        
        .main-buttons {
          flex-direction: column;
        }
        
        button {
          width: 100%;
        }

        .order-selection {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Order Management System</h1>
      
      <div class="main-buttons">
        <button class="btn-primary" onclick="showMarketplace()">Order from Marketplace</button>
        <button class="btn-secondary" onclick="showVirtual()">Order from Virtual Marketplace</button>
      </div>

      <div id="formArea"></div>
    </div>

    <script>
      let sellerOrderData = { sellers: [], orders: [] };

      function showMarketplace() {
        document.getElementById('formArea').innerHTML = '<div class="loading">Loading seller and order data...</div>';
        
        google.script.run
          .withSuccessHandler(function(data) {
            sellerOrderData = data;
            displayMarketplaceForm();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading data:', error);
            displayBasicMarketplaceForm();
          })
          .getSellerOrderData();
      }

      function displayMarketplaceForm() {
        document.getElementById('formArea').innerHTML = `
          <div class="fade-in">
            <h3>Marketplace Order</h3>
            <div id="marketplaceFields">
              ${createMarketplaceEntry(true)}
            </div>
            <div class="action-buttons">
              <button class="btn-add" onclick="addMarketplaceField()">Add Another Order</button>
              <button class="btn-save" onclick="submitMarketplace()">Save and Complete</button>
            </div>
          </div>
        `;
      }

      function displayBasicMarketplaceForm() {
        document.getElementById('formArea').innerHTML = `
          <div class="fade-in">
            <h3>Marketplace Order</h3>
            <div id="marketplaceFields">
              <div class="entry">
                <div class="form-group">
                  <label for="orderID">Order ID</label>
                  <input type="text" name="orderID" placeholder="Enter Order ID">
                </div>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn-add" onclick="addBasicMarketplaceField()">Add Another Order</button>
              <button class="btn-save" onclick="submitBasicMarketplace()">Save and Complete</button>
            </div>
          </div>
        `;
      }

      function createMarketplaceEntry(isFirst = false) {
        const sellerOptions = sellerOrderData.sellers.map(seller => 
          `<option value="${seller}">${seller}</option>`
        ).join('');

        return `
          <div class="entry${isFirst ? '' : ' fade-in'}">
            <div class="order-selection">
              <div class="form-group">
                <label>Select by Seller</label>
                <select class="sellerSelect" onchange="updateOrdersBySelectedSeller(this)">
                  <option value="">Choose a seller...</option>
                  ${sellerOptions}
                </select>
              </div>
              <div class="form-group">
                <label>OR Select Order Directly</label>
                <select class="orderSelect" onchange="updateSellerBySelectedOrder(this)">
                  <option value="">Choose an order...</option>
                  ${sellerOrderData.orders.map(order => 
                    `<option value="${order.orderId}" data-seller="${order.seller}" data-buyer="${order.buyer}">${order.displayText}</option>`
                  ).join('')}
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Order ID</label>
              <input type="text" class="orderIdInput" placeholder="Order ID will be filled automatically" readonly>
            </div>
            <div class="form-group">
              <label>Seller Name</label>
              <input type="text" class="sellerInput" placeholder="Seller name will be filled automatically" readonly>
            </div>
            <div class="form-group">
              <label>Customer/Buyer Name</label>
              <input type="text" class="buyerInput" placeholder="Buyer name will be filled automatically (if available)" readonly>
            </div>
            ${isFirst ? '' : '<button class="btn-remove" onclick="removeMarketplaceField(this)">Remove Section</button>'}
          </div>
        `;
      }

      function updateOrdersBySelectedSeller(sellerSelect) {
        const entry = sellerSelect.closest('.entry');
        const orderSelect = entry.querySelector('.orderSelect');
        const sellerName = sellerSelect.value;
        
        orderSelect.value = '';
        
        if (!sellerName) {
          orderSelect.innerHTML = `
            <option value="">Choose an order...</option>
            ${sellerOrderData.orders.map(order => 
              `<option value="${order.orderId}" data-seller="${order.seller}" data-buyer="${order.buyer}">${order.displayText}</option>`
            ).join('')}
          `;
          clearOrderInputs(entry);
          return;
        }

        google.script.run
          .withSuccessHandler(function(orders) {
            orderSelect.innerHTML = `
              <option value="">Choose an order...</option>
              ${orders.map(order => 
                `<option value="${order.orderId}" data-seller="${order.seller}" data-buyer="${order.buyer}">${order.displayText}</option>`
              ).join('')}
            `;
          })
          .withFailureHandler(function(error) {
            console.error('Error loading orders for seller:', error);
          })
          .getOrdersBySeller(sellerName);

        clearOrderInputs(entry);
      }

      function updateSellerBySelectedOrder(orderSelect) {
        const entry = orderSelect.closest('.entry');
        const sellerSelect = entry.querySelector('.sellerSelect');
        const selectedOption = orderSelect.selectedOptions[0];
        
        if (selectedOption && selectedOption.value) {
          const seller = selectedOption.dataset.seller;
          const buyer = selectedOption.dataset.buyer || '';
          
          sellerSelect.value = seller;
          fillOrderInputs(entry, selectedOption.value, seller, buyer);
        } else {
          sellerSelect.value = '';
          clearOrderInputs(entry);
        }
      }

      function fillOrderInputs(entry, orderId, seller, buyer) {
        entry.querySelector('.orderIdInput').value = orderId;
        entry.querySelector('.sellerInput').value = seller;
        entry.querySelector('.buyerInput').value = buyer;
      }

      function clearOrderInputs(entry) {
        entry.querySelector('.orderIdInput').value = '';
        entry.querySelector('.sellerInput').value = '';
        entry.querySelector('.buyerInput').value = '';
      }

      function showVirtual() {
        document.getElementById('formArea').innerHTML = `
          <div class="fade-in">
            <h3>Virtual Marketplace Order</h3>
            <div id="virtualFields">
              <div class="entry">
                <div class="form-group">
                  <label for="customerName">Customer Name</label>
                  <input type="text" placeholder="Enter Customer Name" class="customerName">
                </div>
                <div class="form-group">
                  <label for="sellerName">Seller Name</label>
                  <input type="text" placeholder="Enter Seller Name" class="sellerName">
                </div>
                <div class="form-group">
                  <label for="endLocation">Final Destination</label>
                  <select class="endLocation">
                    <option value="Medford">Medford</option>
                    <option value="Kingston">Kingston</option>
                    <option value="Shipped">Shipped</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn-add" onclick="addVirtualField()">Add Another Order</button>
              <button class="btn-save" onclick="submitVirtual()">Save and Complete</button>
            </div>
          </div>
        `;
      }

      function addMarketplaceField() {
        const container = document.getElementById('marketplaceFields');
        const div = document.createElement('div');
        div.innerHTML = createMarketplaceEntry(false);
        container.appendChild(div.firstElementChild);
      }

      function addBasicMarketplaceField() {
        const container = document.getElementById('marketplaceFields');
        const div = document.createElement('div');
        div.className = 'entry fade-in';
        div.innerHTML = `
          <div class="form-group">
            <label>Order ID</label>
            <input type="text" name="orderID" placeholder="Enter Order ID">
          </div>
          <button class="btn-remove" onclick="removeMarketplaceField(this)">Remove Section</button>
        `;
        container.appendChild(div);
      }

      function addVirtualField() {
        const container = document.getElementById('virtualFields');
        const div = document.createElement('div');
        div.className = 'entry fade-in';
        div.innerHTML = `
          <div class="form-group">
            <label>Customer Name</label>
            <input type="text" placeholder="Enter Customer Name" class="customerName">
          </div>
          <div class="form-group">
            <label>Seller Name</label>
            <input type="text" placeholder="Enter Seller Name" class="sellerName">
          </div>
          <div class="form-group">
            <label>Final Destination</label>
            <select class="endLocation">
              <option value="Medford">Medford</option>
              <option value="Kingston">Kingston</option>
              <option value="Shipped">Shipped</option>
            </select>
          </div>
          <button class="btn-remove" onclick="removeVirtualField(this)">Remove Section</button>
        `;
        container.appendChild(div);
      }

      function removeMarketplaceField(button) {
        const entry = button.closest('.entry');
        entry.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => entry.remove(), 300);
      }

      function removeVirtualField(button) {
        const entry = button.closest('.entry');
        entry.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => entry.remove(), 300);
      }

      function submitMarketplace() {
        const entries = document.querySelectorAll('#marketplaceFields .entry');
        const data = Array.from(entries).map(entry => {
          const orderId = entry.querySelector('.orderIdInput').value;
          const seller = entry.querySelector('.sellerInput').value;
          const buyer = entry.querySelector('.buyerInput').value;
          
          return {
            orderId: orderId,
            seller: seller,
            buyer: buyer
          };
        }).filter(entry => entry.orderId && entry.orderId.trim() !== '');
        
        if (data.length === 0) {
          alert('Please select at least one order');
          return;
        }
        
        google.script.run.saveMarketplaceOrderWithSeller(data);
        google.script.host.close();
      }

      function submitBasicMarketplace() {
        const inputs = document.querySelectorAll('#marketplaceFields input[name="orderID"]');
        const data = Array.from(inputs).map(input => input.value).filter(value => value.trim() !== '');
        
        if (data.length === 0) {
          alert('Please enter at least one Order ID');
          return;
        }
        
        google.script.run.saveMarketplaceOrder(data);
        google.script.host.close();
      }

      function submitVirtual() {
        const entries = document.querySelectorAll('#virtualFields .entry');
        const data = Array.from(entries).map(entry => {
          return {
            customerName: entry.querySelector('.customerName').value,
            sellerName: entry.querySelector('.sellerName').value,
            endLocation: entry.querySelector('.endLocation').value
          };
        }).filter(entry => entry.customerName.trim() !== '' || entry.sellerName.trim() !== '');
        
        if (data.length === 0) {
          alert('Please fill in at least one entry');
          return;
        }
        
        google.script.run.saveVirtualOrder(data);
        google.script.host.close();
      }
    </script>
  </body>
</html>
